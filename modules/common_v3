#%Module1.0

# Function: check_analysis3_age
# Supports conda/analysis3-YY.MM and conda/analysis3-edge-YY.MM
proc check_analysis3_age {} {
    # Get full module name, e.g. "conda/analysis3-25.08" or "conda/analysis3-edge-25.08"
    set modname [module-info name]

    # Match both stable and edge variants
    if { [regexp {analysis3(?:-edge)?-(\d{2})\.(\d{2})} $modname -> yy mm] } {
        # Parse version numbers as decimal (avoid octal issue)
        set year [expr {2000 + [scan $yy %d]}]
        set month [scan $mm %d]

        # Current date
        set now [clock seconds]
        set current_year [scan [clock format $now -format %Y] %d]
        set current_month [scan [clock format $now -format %m] %d]

        # Convert both to "months since year 0"
        set current_total_months [expr {$current_year * 12 + $current_month}]
        set env_total_months [expr {$year * 12 + $month}]
        set diff_months [expr {$current_total_months - $env_total_months}]

        # Warn if too old, or notify if from the future
        if { $diff_months > 6 } {
            puts stderr "\033\[1;33mWARNING:\033\[0m The environment '$modname' is more than $diff_months months old."
            puts stderr "It will soon be deprecated. Please move to a newer 'conda/analysis3' environment."
        } elseif { $diff_months < -1 } {
            puts stderr "\033\[1;33mNOTICE:\033\[0m The environment '$modname' appears to be from the future ($year-$month)."
            puts stderr "Please verify that you have loaded the correct module."
        }
    } else {
        puts stderr "Note: Could not determine environment version from module name '$modname'."
    }
}

# Run the check only when module is being loaded
if { [module-info mode load] } {
    check_analysis3_age
}

#set-basedir -root __CONDA_BASE__/__APPS_SUBDIR__ -package __CONDA_INSTALL_BASENAME__ -version envs/$::version
set prefix __CONDA_BASE__/__APPS_SUBDIR__
set package __CONDA_INSTALL_BASENAME__
# Name of this module's environment
set condaenv [lindex [split [module-info name] {/}] 1]
set basedir "$prefix/$package/envs/$condaenv"

set mymod [file normalize [info script]]
set mydir [file dirname $mymod]
set myscripts [ file normalize __CONDA_BASE__/__SCRIPT_SUBDIR__/$condaenv.d/bin ]
set overlay_path [ string map {/conda/ /envs/} $basedir ].sqsh

set launcher $myscripts/launcher.sh

module load singularity

prepend-path CONTAINER_OVERLAY_PATH $overlay_path
prepend-path SINGULARITYENV_PREPEND_PATH $basedir/condabin

if {[module-info mode remove]} {
    if {$env(CONDA_SHLVL) > 1} {
        puts stderr "ERROR: Multiple ($::env(CONDA_SHLVL)) conda environments have been loaded, cannot unload with module"
        puts stderr "ERROR: Try 'conda deactivate' first"
        break
    }
}

if { [ file exists $mydir/.$condaenv ] } {
    source $mydir/.$condaenv
} else {
    puts stderr "ERROR! Environment spec is missing!"
    exit 1
}

### Extra env to get other things working
setenv OMPI_MCA_orte_launch_agent $myscripts/orted
setenv MAMBA_ROOT_PREFIX $prefix/$package
setenv CONDA_EXE $prefix/$package/bin/micromamba

### Set Python path for Dask PBSCluster
setenv DASK_JOBQUEUE__PBS__PYTHON /g/data/xp65/public/apps/med_conda_scripts/$condaenv.d/bin/python

### Set the path to the benchcab utility
setenv BENCHCAB_PATH /g/data/xp65/public/apps/med_conda_scripts/$condaenv.d/bin/benchcab
### Set launcher script path for payu
setenv ENV_LAUNCHER_SCRIPT_PATH /g/data/xp65/public/apps/med_conda_scripts/$condaenv.d/bin/launcher.sh
### Set the path to the cartopy pre existing data
setenv CARTOPY_DATA_DIR /g/data/xp65/public/apps/cartopy-data
### Set configuration for the Rapid Evaluation Framework
setenv REF_DATASET_CACHE_DIR /scratch/xp65/climate-ref-cache
setenv REF_CONFIGURATION /g/data/xp65/public/apps/climate-ref
### Add uqstat 
prepend-path PATH /g/data/xp65/public/apps/nci_scripts

# Fix Open MPI relocation (moved from hh5 -> xp65)
set root /g/data/xp65/public/apps/openmpi/4.1.6

setenv OPAL_PREFIX $root
prepend-path PATH $root/bin

# Libraries (add whichever exists)
if { [file isdirectory $root/lib] } {
    prepend-path LD_LIBRARY_PATH $root/lib
}
if { [file isdirectory $root/lib64] } {
    prepend-path LD_LIBRARY_PATH $root/lib64
}

# Nice-to-have
if { [file isdirectory $root/share/man] } {
    prepend-path MANPATH $root/share/man
}
if { [file isdirectory $root/lib/pkgconfig] } {
    prepend-path PKG_CONFIG_PATH $root/lib/pkgconfig
}
if { [file isdirectory $root/lib64/pkgconfig] } {
    prepend-path PKG_CONFIG_PATH $root/lib64/pkgconfig
}
