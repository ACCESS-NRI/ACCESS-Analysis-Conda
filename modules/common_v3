#%Module1.0
source /opt/Modules/extensions/extensions.tcl

set-basedir -root __CONDA_BASE__/__APPS_SUBDIR__ -package __CONDA_INSTALL_BASENAME__ -version envs/$::version
set rootdir [ string map [ list /envs/$::version {} ] $::basedir ]

inhibit-self-conflict

module load singularity

prepend-path PATH $rootdir/condabin

set mymod [file normalize [info script]]
set mydir [file dirname $mymod]
set myscripts [ file normalize __CONDA_BASE__/__SCRIPT_SUBDIR__/$::version.d/bin ]
set overlay_path [ string map {/conda/ /envs/} $::basedir ].sqsh

set launcher $myscripts/launcher.sh

prepend-path CONTAINER_OVERLAY_PATH $overlay_path
prepend-path SINGULARITYENV_PREPEND_PATH $::basedir/condabin

if {[module-info mode remove]} {
    if {$env(CONDA_SHLVL) > 1} {
        puts stderr "ERROR: Multiple ($::env(CONDA_SHLVL)) conda environments have been loaded, cannot unload with module"
        puts stderr "ERROR: Try 'conda deactivate' first"
        break
    }
}

# Name of this module's environment
set condaenv [lindex [split [module-info name] {/}] 1]

if { [ file exists $mydir/.$condaenv ] } {
    source $mydir/.$condaenv
} else {
    puts stderr "ERROR! Environment spec is missing!"
    exit 1
}

### Extra env to get other things working
setenv  OMPI_MCA_orte_launch_agent $myscripts/orted